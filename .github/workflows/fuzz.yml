name: Fuzz Testing

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      target:
        description: 'Fuzz target to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - fuzz_nbd_client_flags
          - fuzz_nbd_option_header
          - fuzz_nbd_request
          - fuzz_protocol_sequence
      duration:
        description: 'Fuzz duration per target (seconds)'
        required: true
        default: '300'
        type: string
  # Scheduled weekly run
  schedule:
    - cron: '0 3 * * 0'  # Sunday 3am UTC

env:
  CARGO_TERM_COLOR: always

jobs:
  fuzz:
    name: Fuzz ${{ github.event.inputs.target || 'all' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: glidefs

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: llvm-tools-preview

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz

      - name: Build fuzz targets
        run: cargo +nightly fuzz build

      - name: Run fuzz targets
        run: |
          DURATION="${{ github.event.inputs.duration || '300' }}"
          TARGET="${{ github.event.inputs.target || 'all' }}"

          if [ "$TARGET" = "all" ]; then
            for target in fuzz_nbd_client_flags fuzz_nbd_option_header fuzz_nbd_request fuzz_protocol_sequence; do
              echo ""
              echo "╔═══════════════════════════════════════════════════════════════╗"
              echo "║ Fuzzing: $target (${DURATION}s)"
              echo "╚═══════════════════════════════════════════════════════════════╝"
              cargo +nightly fuzz run "$target" -- -max_total_time="$DURATION" || {
                echo "::error::Fuzzer found a crash in $target"
                exit 1
              }
            done
          else
            echo "Fuzzing $TARGET for ${DURATION}s..."
            cargo +nightly fuzz run "$TARGET" -- -max_total_time="$DURATION"
          fi

      - name: Upload crash artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-crashes-${{ github.run_id }}
          path: glidefs/fuzz/artifacts/
          retention-days: 30

      - name: Upload corpus
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-corpus-${{ github.run_id }}
          path: glidefs/fuzz/corpus/
          retention-days: 7
